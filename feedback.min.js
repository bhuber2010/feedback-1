/*!
 * FEEDBACK 0.1.0-alpha (https://github.com/developdaly/feedback-1)
 * Copyright 2015 Patrick Daly <patrick@developdaly.com>
 */
!function(a){a.feedback=function(b){function c(b,c){c="undefined"!=typeof c?c:!0,b.clearRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height()),b.fillStyle="rgba(102,102,102,0.5)",b.fillRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height()),a(".feedback-helper").each(function(){"highlight"===a(this).attr("data-type")&&c&&d(b,parseInt(a(this).css("left"),e),parseInt(a(this).css("top"),e),a(this).width(),a(this).height())}),a(".feedback-helper").each(function(){"highlight"===a(this).attr("data-type")&&b.clearRect(parseInt(a(this).css("left"),e),parseInt(a(this).css("top"),e),a(this).width(),a(this).height())}),a(".feedback-helper").each(function(){"blackout"===a(this).attr("data-type")&&(b.fillStyle="rgba(0,0,0,1)",b.fillRect(parseInt(a(this).css("left"),e),parseInt(a(this).css("top"),e),a(this).width(),a(this).height()))})}function d(a,b,c,d,e){a.strokeStyle=i.strokeStyle,a.shadowColor=i.shadowColor,a.shadowOffsetX=i.shadowOffsetX,a.shadowOffsetY=i.shadowOffsetY,a.shadowBlur=i.shadowBlur,a.lineJoin=i.lineJoin,a.lineWidth=i.lineWidth,a.strokeRect(b,c,d,e),a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0,a.lineWidth=1}var e=10,f=4e4,g=2,h=6,i=a.extend({ajaxURL:"",postBrowserInfo:!0,postHTML:!0,postURL:!0,proxy:void 0,letterRendering:!1,initButtonText:"Send feedback",strokeStyle:"black",shadowColor:"black",shadowOffsetX:1,shadowOffsetY:1,shadowBlur:e,lineJoin:"bevel",lineWidth:3,html2canvasURL:"html2canvas.js",feedbackButton:".feedback-btn",showDescriptionModal:!0,isDraggable:!0,onScreenshotTaken:function(){},tpl:{description:'<div id="feedback-welcome"><div class="feedback-logo">Feedback</div><p>Feedback lets you send us suggestions about our products. We welcome problem reports, feature ideas and general comments.</p><p>Start by writing a brief description:</p><textarea id="feedback-note-tmp"></textarea><p>Next we\'ll let you identify areas of the page related to your description.</p><button id="feedback-welcome-next" class="feedback-next-btn feedback-btn-gray">Next</button><div id="feedback-welcome-error">Please enter a description.</div><div class="feedback-wizard-close"></div></div>',highlighter:'<div id="feedback-highlighter"><div class="feedback-logo">Feedback</div><p>Click and drag on the page to help us better understand your feedback. You can move this dialog if it\'s in the way.</p><button class="feedback-sethighlight feedback-active"><div class="ico"></div><span>Highlight</span></button><label>Highlight areas relevant to your feedback.</label><button class="feedback-setblackout"><div class="ico"></div><span>Black out</span></button><label class="lower">Black out any personal information.</label><div class="feedback-buttons"><button id="feedback-highlighter-next" class="feedback-next-btn feedback-btn-gray">Next</button><button id="feedback-highlighter-back" class="feedback-back-btn feedback-btn-gray">Back</button></div><div class="feedback-wizard-close"></div></div>',overview:'<div id="feedback-overview"><div class="feedback-logo">Feedback</div><div id="feedback-overview-description"><div id="feedback-overview-description-text"><h3>Description</h3><h3 class="feedback-additional">Additional info</h3><div id="feedback-additional-none"><span>None</span></div><div id="feedback-browser-info"><span>Browser Info</span></div><div id="feedback-page-info"><span>Page Info</span></div><div id="feedback-page-structure"><span>Page Structure</span></div></div></div><div id="feedback-overview-screenshot"><h3>Screenshot</h3></div><div class="feedback-buttons"><button id="feedback-submit" class="feedback-submit-btn feedback-btn-blue">Submit</button><button id="feedback-overview-back" class="feedback-back-btn feedback-btn-gray">Back</button></div><div id="feedback-overview-error">Please enter a description.</div><div class="feedback-wizard-close"></div></div>',submitSuccess:'<div id="feedback-submit-success"><div class="feedback-logo">Feedback</div><p>Thank you for your feedback. We value every piece of feedback we receive.</p><p>We cannot respond individually to every one, but we will use your comments as we strive to improve your experience.</p><button class="feedback-close-btn feedback-btn-blue">OK</button><div class="feedback-wizard-close"></div></div>',submitError:'<div id="feedback-submit-error"><div class="feedback-logo">Feedback</div><p>Sadly an error occured while sending your feedback. Please try again.</p><button class="feedback-close-btn feedback-btn-blue">OK</button><div class="feedback-wizard-close"></div></div>'},onClose:function(){},screenshotStroke:!0,highlightElement:!0,initialBox:!1},b),j=!!window.HTMLCanvasElement,k=".feedback-btn"===i.feedbackButton,l=!1;j&&(k&&a("body").append('<button class="feedback-btn feedback-btn-gray">'+i.initButtonText+"</button>"),a(document).on("click",i.feedbackButton,function(){k&&a(this).hide(),l||a.getScript(i.html2canvasURL,function(){l=!0});var b=!1,j="",m=a(document).height(),n=a(document).width(),o='<div id="feedback-module">';i.initialBox&&(o+=i.tpl.description),o+=i.tpl.highlighter+i.tpl.overview+'<canvas id="feedback-canvas"></canvas><div id="feedback-helpers"></div><input id="feedback-note" name="feedback-note" type="hidden"></div>',a("body").append(o);var p={position:"absolute",left:"0px",top:"0px"},q={width:n,height:m};a("#feedback-module").css(p),a("#feedback-canvas").attr(q).css("z-index","30000"),i.initialBox||(a("#feedback-highlighter-back").remove(),b=!0,a("#feedback-canvas").css("cursor","crosshair"),a("#feedback-helpers").show(),a("#feedback-welcome").hide(),a("#feedback-highlighter").show()),i.isDraggable&&a("#feedback-highlighter").on("mousedown",function(b){var c=a(this).addClass("feedback-draggable"),d=c.outerHeight(),e=c.outerWidth(),g=c.offset().top+d-b.pageY,h=c.offset().left+e-b.pageX;c.css("z-index",f).parents().on("mousemove",function(b){var c=b.pageY+g-d,f=b.pageX+h-e,i=d-b.pageY,j=e-b.pageX;0>f&&(f=0),0>c&&(c=0),j>a(window).width()&&(f=a(window).width()-e),f>a(window).width()-e&&(f=a(window).width()-e),i>a(document).height()&&(c=a(document).height()-d),c>a(document).height()-d&&(c=a(document).height()-d),a(".feedback-draggable").offset({top:c,left:f}).on("mouseup",function(){a(this).removeClass("feedback-draggable")})}),b.preventDefault()}).on("mouseup",function(){a(this).removeClass("feedback-draggable"),a(this).parents().off("mousemove mousedown")});var r=a("#feedback-canvas")[0].getContext("2d");r.fillStyle="rgba(102,102,102,0.5)",r.fillRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height());var s={},t=!1,u=1,v={};if(i.postBrowserInfo&&(v.browser={},v.browser.appCodeName=navigator.appCodeName,v.browser.appName=navigator.appName,v.browser.appVersion=navigator.appVersion,v.browser.cookieEnabled=navigator.cookieEnabled,v.browser.onLine=navigator.onLine,v.browser.platform=navigator.platform,v.browser.userAgent=navigator.userAgent,v.browser.plugins=[],a.each(navigator.plugins,function(a){v.browser.plugins.push(navigator.plugins[a].name)}),a("#feedback-browser-info").show()),i.postURL&&(v.url=document.URL,a("#feedback-page-info").show()),i.postHTML&&(v.html=a("html").html(),a("#feedback-page-structure").show()),i.postBrowserInfo||i.postURL||i.postHTML||a("#feedback-additional-none").show(),a(document).on("mousedown","#feedback-canvas",function(c){b&&(s.startX=c.pageX-a(this).offset().left,s.startY=c.pageY-a(this).offset().top,s.w=0,s.h=0,t=!0)}),a(document).on("mouseup",function(){if(b){t=!1;var d=s.startY,e=s.startX,f=s.w,g=s.h,h="highlight";if(0===f||0===g)return;0>f&&(e+=f,f*=-1),0>g&&(d+=g,g*=-1),d+g>a(document).height()&&(g=a(document).height()-d),e+f>a(document).width()&&(f=a(document).width()-e),0===u&&(h="blackout"),a("#feedback-helpers").append('<div class="feedback-helper" data-type="'+h+'" data-time="'+Date.now()+'" style="position:absolute;top:'+d+"px;left:"+e+"px;width:"+f+"px;height:"+g+'px;z-index:30000;"></div>'),c(r),s.w=0}}),a(document).on("mousemove",function(c){b&&t&&(a("#feedback-highlighter").css("cursor","default"),s.w=c.pageX-a("#feedback-canvas").offset().left-s.startX,s.h=c.pageY-a("#feedback-canvas").offset().top-s.startY,r.clearRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height()),r.fillStyle="rgba(102,102,102,0.5)",r.fillRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height()),a(".feedback-helper").each(function(){"highlight"===a(this).attr("data-type")&&d(r,parseInt(a(this).css("left"),e),parseInt(a(this).css("top"),e),a(this).width(),a(this).height())}),1===u&&(d(r,s.startX,s.startY,s.w,s.h),r.clearRect(s.startX,s.startY,s.w,s.h)),a(".feedback-helper").each(function(){"highlight"===a(this).attr("data-type")&&r.clearRect(parseInt(a(this).css("left"),e),parseInt(a(this).css("top"),e),a(this).width(),a(this).height())}),a(".feedback-helper").each(function(){"blackout"===a(this).attr("data-type")&&(r.fillStyle="rgba(0,0,0,1)",r.fillRect(parseInt(a(this).css("left"),e),parseInt(a(this).css("top"),e),a(this).width(),a(this).height()))}),0===u&&(r.fillStyle="rgba(0,0,0,0.5)",r.fillRect(s.startX,s.startY,s.w,s.h)))}),i.highlightElement){var w=[],x=[],y=0;a(document).on("mousemove click","#feedback-canvas",function(f){if(b){var i;c(r),x=[],a("#feedback-canvas").css("cursor","crosshair"),a("* :not(body,script,iframe,div,section,.feedback-btn,#feedback-module *)").each(function(){"true"!==a(this).attr("data-highlighted")&&f.pageX>a(this).offset().left&&f.pageX<a(this).offset().left+a(this).width()&&f.pageY>a(this).offset().top+parseInt(a(this).css("padding-top"),e)&&f.pageY<a(this).offset().top+a(this).height()+parseInt(a(this).css("padding-top"),e)&&x.push(a(this))});var j=x[x.length-1];if(j&&!t){a("#feedback-canvas").css("cursor","pointer");var k=j.offset().left-g,l=j.offset().top-g,m=j.width()+parseInt(j.css("padding-left"),e)+parseInt(j.css("padding-right"),e)+h,n=j.height()+parseInt(j.css("padding-top"),e)+parseInt(j.css("padding-bottom"),e)+h;1===u&&(d(r,k,l,m,n),r.clearRect(k,l,m,n),i="highlight"),a(".feedback-helper").each(function(){"highlight"===a(this).attr("data-type")&&r.clearRect(parseInt(a(this).css("left"),e),parseInt(a(this).css("top"),e),a(this).width(),a(this).height())}),0===u&&(i="blackout",r.fillStyle="rgba(0,0,0,0.5)",r.fillRect(k,l,m,n)),a(".feedback-helper").each(function(){"blackout"===a(this).attr("data-type")&&(r.fillStyle="rgba(0,0,0,1)",r.fillRect(parseInt(a(this).css("left"),e),parseInt(a(this).css("top"),e),a(this).width(),a(this).height()))}),"click"===f.type&&f.pageX===s.startX&&f.pageY===s.startY&&(a("#feedback-helpers").append('<div class="feedback-helper" data-highlight-id="'+y+'" data-type="'+i+'" data-time="'+Date.now()+'" style="position:absolute;top:'+l+"px;left:"+k+"px;width:"+m+"px;height:"+n+'px;z-index:30000;"></div>'),w.push(y),++y,c(r))}}})}a(document).on("mouseleave","body,#feedback-canvas",function(){c(r)}),a(document).on("mouseenter",".feedback-helper",function(){c(r)}),a(document).on("click","#feedback-welcome-next",function(){a("#feedback-note").val().length>0?(b=!0,a("#feedback-canvas").css("cursor","crosshair"),a("#feedback-helpers").show(),a("#feedback-welcome").hide(),a("#feedback-highlighter").show()):a("#feedback-welcome-error").show()}),a(document).on("mouseenter mouseleave",".feedback-helper",function(b){if(!t)if(s.w=0,s.h=0,"mouseenter"===b.type){if(a(this).css("z-index","30001"),a(this).append('<div class="feedback-helper-inner" style="width:'+(a(this).width()-g)+"px;height:"+(a(this).height()-g)+'px;position:absolute;margin:1px;"></div>'),a(this).append('<div id="feedback-close"></div>'),a(this).find("#feedback-close").css({top:-1*(a(this).find("#feedback-close").height()/g)+"px",left:a(this).width()-a(this).find("#feedback-close").width()/g+"px"}),"blackout"===a(this).attr("data-type")){r.clearRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height()),r.fillStyle="rgba(102,102,102,0.5)",r.fillRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height()),a(".feedback-helper").each(function(){"highlight"===a(this).attr("data-type")&&d(r,parseInt(a(this).css("left"),e),parseInt(a(this).css("top"),e),a(this).width(),a(this).height())}),a(".feedback-helper").each(function(){"highlight"===a(this).attr("data-type")&&r.clearRect(parseInt(a(this).css("left"),e),parseInt(a(this).css("top"),e),a(this).width(),a(this).height())}),r.clearRect(parseInt(a(this).css("left"),e),parseInt(a(this).css("top"),e),a(this).width(),a(this).height()),r.fillStyle="rgba(0,0,0,0.75)",r.fillRect(parseInt(a(this).css("left"),e),parseInt(a(this).css("top"),e),a(this).width(),a(this).height());var f=a(this).attr("data-time");a(".feedback-helper").each(function(){return a(this).attr("data-time")===f?!0:void("blackout"===a(this).attr("data-type")&&(r.fillStyle="rgba(0,0,0,1)",r.fillRect(parseInt(a(this).css("left"),e),parseInt(a(this).css("top"),e),a(this).width(),a(this).height())))})}}else a(this).css("z-index","30000"),a(this).children().remove(),"blackout"===a(this).attr("data-type")&&c(r)}),a(document).on("click","#feedback-close",function(){var b;i.highlightElement&&a(this).parent().attr("data-highlight-id")&&(b=a(this).parent().attr("data-highlight-id")),a(this).parent().remove(),i.highlightElement&&b&&a('[data-highlight-id="'+b+'"]').removeAttr("data-highlighted").removeAttr("data-highlight-id"),c(r)}),a("#feedback-module").on("click",".feedback-wizard-close,.feedback-close-btn",function(){close()}),a(document).on("keyup",function(a){27===a.keyCode&&close()}),a(document).on("selectstart dragstart",document,function(a){a.preventDefault()}),a(document).on("click","#feedback-highlighter-back",function(){b=!1,a("#feedback-canvas").css("cursor","default"),a("#feedback-helpers").hide(),a("#feedback-highlighter").hide(),a("#feedback-welcome-error").hide(),a("#feedback-welcome").show()}),a(document).on("mousedown",".feedback-sethighlight",function(){u=1,a(this).addClass("feedback-active"),a(".feedback-setblackout").removeClass("feedback-active")}),a(document).on("mousedown",".feedback-setblackout",function(){u=0,a(this).addClass("feedback-active"),a(".feedback-sethighlight").removeClass("feedback-active")}),a(document).on("click","#feedback-highlighter-next",function(){b=!1,a("#feedback-canvas").css("cursor","default");var d=a(document).scrollTop(),e=a(window).height();a("#feedback-helpers").hide(),a("#feedback-highlighter").hide(),i.screenshotStroke||c(r,!1),html2canvas(a("body"),{onrendered:function(b){i.screenshotStroke||c(r);var f=a('<canvas id="feedback-canvas-tmp" width="'+n+'" height="'+e+'"/>').hide().appendTo("body"),g=f.get(0).getContext("2d");g.drawImage(b,0,d,n,e,0,0,n,e),j=f.get(0).toDataURL(),a(document).scrollTop(d),v.img=j,i.onScreenshotTaken(v.img),i.showDescriptionModal?(a("#feedback-canvas-tmp").remove(),a("#feedback-overview").show(),a("#feedback-overview-description-text>textarea").remove(),a("#feedback-overview-screenshot>img").remove(),a('<textarea id="feedback-overview-note">'+a("#feedback-note").val()+"</textarea>").insertAfter("#feedback-overview-description-text h3:eq(0)"),a("#feedback-overview-screenshot").append('<img class="feedback-screenshot" src="'+j+'" />')):(a("#feedback-module").remove(),close(),f.remove())},proxy:i.proxy,letterRendering:i.letterRendering})}),a(document).on("click","#feedback-overview-back",function(){b=!0,a("#feedback-canvas").css("cursor","crosshair"),a("#feedback-overview").hide(),a("#feedback-helpers").show(),a("#feedback-highlighter").show(),a("#feedback-overview-error").hide()}),a(document).on("keyup","#feedback-note-tmp,#feedback-overview-note",function(b){var c;"feedback-note-tmp"===b.target.id?c=a("#feedback-note-tmp").val():(c=a("#feedback-overview-note").val(),a("#feedback-note-tmp").val(c)),a("#feedback-note").val(c)}),a(document).on("click","#feedback-submit",function(){if(b=!1,a("#feedback-note").val().length>0){a("#feedback-submit-success,#feedback-submit-error").remove(),a("#feedback-overview").hide(),v.img=j,v.note=a("#feedback-note").val();var c={feedback:JSON.stringify(v)};a.ajax({url:i.ajaxURL,dataType:"json",type:"POST",data:c,success:function(){a("#feedback-module").append(i.tpl.submitSuccess)},error:function(){a("#feedback-module").append(i.tpl.submitError)}})}else a("#feedback-overview-error").show()})}))}}(jQuery);